name: Documentation Remove

on:
  pull_request_target:
    types: [closed]
    branches:
      - haltium-ncs

jobs:
  remove:
    runs-on: ubuntu-latest

    steps:
      - name: Install azcopy
        run: |
          sudo apt update
          wget -P azcopy/bin https://azcopyvnext.azureedge.net/release20221108/azcopy_linux_amd64_10.16.2.tar.gz
          cd azcopy/bin && tar --strip-components=1 -xzf azcopy_linux_amd64_10.16.2.tar.gz
          echo "${PWD}/azcopy/bin >> $GITHUB_PATH"
          azcopy -v

      - name: AzCopy login
        env:
          AZCOPY_SPA_APPLICATION_ID: ${{ secrets.AZCOPY_SPA_APPLICATION_ID }}
          AZCOPY_SPA_TENANT_ID: ${{ secrets.AZCOPY_SPA_TENANT_ID }}
          AZCOPY_SPA_CLIENT_SECRET: ${{ secrets.AZCOPY_SPA_CLIENT_SECRET }}
        run: azcopy login --service-principal --application-id ${AZCOPY_SPA_APPLICATION_ID} --tenant-id ${AZCOPY_SPA_TENANT_ID}

      - name: Remove PR-html
        run: |
          name="PR-${{ github.event.number }}"
          mkdir -p $GITHUB_WORKSPACE/azcopy_logs
          export AZCOPY_LOG_LOCATION="${GITHUB_WORKSPACE}/azcopy_logs/docsync.log"
          azcopy remove "https://ncsdocsa.blob.core.windows.net/ncs-documentation-dev/$name/" --recursive --log-level=WARNING

          if [[ -f "$GITHUB_WORKSPACE/azcopy_logs/docsync.log" ]]; then
            cat $GITHUB_WORKSPACE/azcopy_logs/docsync.log
          fi
